name: Helm Validation

on:
  push:
    branches:
      - main
    paths:
      - 'infra/k8s/**'
  pull_request:
    paths:
      - 'infra/k8s/**'
  workflow_dispatch:

jobs:
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Lint Helm charts
        run: |
          echo "Linting Helm charts..."
          for chart in infra/k8s/helm/*/; do
            if [ -f "$chart/Chart.yaml" ]; then
              echo "Linting chart: $chart"
              helm lint "$chart"
            fi
          done

  helm-template:
    name: Helm Template Rendering
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Render Helm templates
        run: |
          echo "Rendering Helm templates..."
          for chart in infra/k8s/helm/*/; do
            if [ -f "$chart/Chart.yaml" ]; then
              chart_name=$(basename "$chart")
              echo "Rendering chart: $chart_name"
              helm template "$chart_name" "$chart" \
                --set tts.image.tag=test \
                --set agent.image.tag=test \
                --set tts.resources.limits.nvidia.com/gpu=1 \
                --output-dir /tmp/rendered-manifests/"$chart_name"
              
              echo "Validating rendered YAML syntax..."
              find /tmp/rendered-manifests/"$chart_name" -name "*.yaml" -exec echo "Checking {}" \; -exec cat {} \;
            fi
          done

      - name: Upload rendered manifests
        uses: actions/upload-artifact@v5
        with:
          name: rendered-manifests
          path: /tmp/rendered-manifests/
          retention-days: 7

  kind-test:
    name: Kind Cluster Test (Optional)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-k8s]')
    needs: [helm-lint, helm-template]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: helm-test
          wait: 60s

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Install cert-manager (dependency)
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
          kubectl wait --for=condition=Available --timeout=300s deployment/cert-manager -n cert-manager
          kubectl wait --for=condition=Available --timeout=300s deployment/cert-manager-webhook -n cert-manager
          kubectl wait --for=condition=Available --timeout=300s deployment/cert-manager-cainjector -n cert-manager

      - name: Apply Helm manifests
        run: |
          for chart in infra/k8s/helm/*/; do
            if [ -f "$chart/Chart.yaml" ]; then
              chart_name=$(basename "$chart")
              echo "Installing chart: $chart_name"
              
              # Create namespace
              kubectl create namespace voice-agent || true
              
              # Install chart with test values
              helm install "$chart_name" "$chart" \
                --namespace voice-agent \
                --set tts.image.tag=test \
                --set tts.image.pullPolicy=Never \
                --set agent.image.tag=test \
                --set agent.image.pullPolicy=Never \
                --set tts.resources.limits.nvidia.com/gpu=0 \
                --set tts.replicaCount=1 \
                --set agent.replicaCount=1 \
                --wait --timeout=5m || echo "Installation failed (expected without actual images)"
            fi
          done

      - name: Verify basic connectivity
        run: |
          echo "Checking deployed resources..."
          kubectl get all -n voice-agent
          
          echo "Checking services..."
          kubectl get svc -n voice-agent
          
          echo "Describing pods (if any)..."
          kubectl get pods -n voice-agent || true

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster Events ==="
          kubectl get events -n voice-agent --sort-by='.lastTimestamp'
          
          echo "=== Pod Descriptions ==="
          kubectl describe pods -n voice-agent || true
          
          echo "=== Pod Logs ==="
          for pod in $(kubectl get pods -n voice-agent -o name); do
            echo "Logs for $pod:"
            kubectl logs "$pod" -n voice-agent --all-containers=true || true
          done
