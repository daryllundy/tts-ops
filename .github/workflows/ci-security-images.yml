name: Container Security Scanning

"on":
    workflow_run:
        workflows: ["Build and Push"]
        types: [completed]
    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    scan-images:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
        permissions:
            contents: read
            security-events: write
            packages: read
        
        strategy:
            matrix:
                service: [tts-service, agent-service]
            fail-fast: false

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Determine image tag
              id: image-tag
              run: |
                  # Use the git SHA from the triggering workflow or current commit
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                      TAG="sha-${{ github.sha }}"
                  else
                      TAG="sha-${{ github.event.workflow_run.head_sha }}"
                  fi
                  
                  # For main branch, also try 'latest' tag
                  if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                      TAG="latest"
                  fi
                  
                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "Using image tag: $TAG"

            - name: Pull image
              run: |
                  IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ steps.image-tag.outputs.tag }}"
                  echo "Pulling image: $IMAGE"
                  docker pull "$IMAGE" || {
                      echo "::warning::Failed to pull image with tag ${{ steps.image-tag.outputs.tag }}, trying 'latest'"
                      docker pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:latest"
                  }

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ steps.image-tag.outputs.tag }}
                  format: 'sarif'
                  output: 'trivy-results-${{ matrix.service }}.sarif'
                  severity: 'CRITICAL,HIGH,MEDIUM,LOW'

            - name: Run Trivy for human-readable output
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ steps.image-tag.outputs.tag }}
                  format: 'table'
                  severity: 'CRITICAL,HIGH,MEDIUM,LOW'

            - name: Run Trivy for JSON report
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ steps.image-tag.outputs.tag }}
                  format: 'json'
                  output: 'trivy-results-${{ matrix.service }}.json'
                  severity: 'CRITICAL,HIGH,MEDIUM,LOW'

            - name: Upload Trivy results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              with:
                  sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
                  category: 'container-${{ matrix.service }}'

            - name: Upload scan results as artifacts
              uses: actions/upload-artifact@v6
              if: always()
              with:
                  name: trivy-scan-${{ matrix.service }}
                  path: |
                      trivy-results-${{ matrix.service }}.sarif
                      trivy-results-${{ matrix.service }}.json
                  retention-days: 90

            - name: Check for critical CVEs
              run: |
                  # Parse JSON report and fail on critical CVEs
                  if [ -f "trivy-results-${{ matrix.service }}.json" ]; then
                      CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results-${{ matrix.service }}.json)
                      HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results-${{ matrix.service }}.json)
                      
                      echo "Critical vulnerabilities: $CRITICAL_COUNT"
                      echo "High vulnerabilities: $HIGH_COUNT"
                      
                      if [ "$CRITICAL_COUNT" -gt 0 ]; then
                          echo "::error::Found $CRITICAL_COUNT critical CVEs in ${{ matrix.service }} image"
                          
                          # List critical CVEs
                          echo "Critical CVEs:"
                          jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL") | "- \(.VulnerabilityID): \(.PkgName) \(.InstalledVersion) (Fixed: \(.FixedVersion // "N/A"))"' trivy-results-${{ matrix.service }}.json
                          
                          exit 1
                      fi
                      
                      echo "No critical CVEs found in ${{ matrix.service }} image"
                  else
                      echo "::warning::Trivy results file not found"
                  fi

    summary:
        runs-on: ubuntu-latest
        needs: scan-images
        if: always()
        steps:
            - name: Check scan results
              run: |
                  if [ "${{ needs.scan-images.result }}" == "failure" ]; then
                      echo "::error::Container security scanning failed - critical vulnerabilities found"
                      exit 1
                  else
                      echo "Container security scanning completed successfully"
                  fi
