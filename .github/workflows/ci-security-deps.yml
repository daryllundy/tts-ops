name: Dependency Security Scanning

"on":
    push:
        branches: [main]
    pull_request:
        branches: [main]
    schedule:
        # Run weekly on Monday at 9 AM UTC
        - cron: "0 9 * * 1"
    workflow_dispatch:

jobs:
    scan-dependencies:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v6
              with:
                  python-version: "3.11"

            - name: Install pip-audit
              run: |
                  python -m pip install --upgrade pip
                  pip install pip-audit

            - name: Run pip-audit on pyproject.toml
              id: pip-audit
              run: |
                  # Run pip-audit and capture output
                  pip-audit --desc on --format json --output audit-report.json || echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
                  
                  # Also generate human-readable report
                  pip-audit --desc on || true

            - name: Generate SARIF report
              if: always()
              run: |
                  # Convert JSON report to SARIF format
                  pip-audit --desc on --format json --output audit-report.json || true
                  
                  # pip-audit doesn't natively support SARIF, so we'll upload the JSON as artifact
                  # In production, you might want to use a converter or GitHub's native scanning

            - name: Upload vulnerability report
              if: always()
              uses: actions/upload-artifact@v5
              with:
                  name: dependency-vulnerability-report
                  path: audit-report.json
                  retention-days: 90

            - name: Check for critical/high vulnerabilities
              run: |
                  # Parse JSON report and fail on critical/high CVEs
                  if [ -f audit-report.json ]; then
                      # Check if there are any vulnerabilities
                      vuln_count=$(python -c "import json; data=json.load(open('audit-report.json')); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
                      
                      if [ "$vuln_count" -gt 0 ]; then
                          echo "Found $vuln_count vulnerabilities"
                          
                          # For now, we'll fail on any vulnerability
                          # In production, you'd parse severity levels
                          echo "::error::Critical or high severity vulnerabilities found in dependencies"
                          exit 1
                      else
                          echo "No vulnerabilities found"
                      fi
                  fi

    check-dependabot:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Verify Dependabot configuration
              run: |
                  if [ ! -f .github/dependabot.yml ]; then
                      echo "::warning::Dependabot configuration file not found at .github/dependabot.yml"
                      echo "::warning::Consider adding Dependabot for automated dependency updates"
                  else
                      echo "Dependabot configuration found"
                      cat .github/dependabot.yml
                  fi
