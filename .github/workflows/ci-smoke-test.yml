name: Smoke Test

"on":
    workflow_run:
        workflows: ["Build and Push"]
        types:
            - completed

jobs:
    smoke-test:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull images
              run: |
                  docker pull ghcr.io/${{ github.repository }}/tts-service:main || true
                  docker pull ghcr.io/${{ github.repository }}/agent-service:main || true

            - name: Start services
              run: docker compose up -d

            - name: Wait for services to be ready
              run: sleep 10

            - name: Run smoke tests
              run: python3 scripts/smoke_test.py --url http://localhost:8000 --retries 10 --timeout 5

            - name: Stop services
              if: always()
              run: docker compose down

            - name: Upload logs on failure
              if: failure()
              uses: actions/upload-artifact@v3
              with:
                  name: container-logs
                  path: |
                      docker-compose-logs.txt
